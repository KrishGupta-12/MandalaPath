rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user profiles.  Only the user can read/write their profile.
     * @path /users/{userId}
     * @allow (create) User '4t3ExI1SrUd7NeqJaMX4p0MtniB2' can create their own profile document at /users/4t3ExI1SrUd7NeqJaMX4p0MtniB2 if the googleId matches.
     * @allow (get) User '4t3ExI1SrUd7NeqJaMX4p0MtniB2' can read their own profile document at /users/4t3ExI1SrUd7NeqJaMX4p0MtniB2.
     * @allow (update) User '4t3ExI1SrUd7NeqJaMX4p0MtniB2' can update their own profile document at /users/4t3ExI1SrUd7NeqJaMX4p0MtniB2.
     * @allow (delete) User '4t3ExI1SrUd7NeqJaMX4p0MtniB2' can delete their own profile document at /users/4t3ExI1SrUd7NeqJaMX4p0MtniB2.
     * @deny (create) User '4t3ExI1SrUd7NeqJaMX4p0MtniB2' cannot create a profile for a different user at /users/someOtherUserId.
     * @deny (get) User 'randomId' cannot read the profile for a different user at /users/4t3ExI1SrUd7NeqJaMX4p0MtniB2.
     * @deny (update) User 'randomId' cannot update the profile for a different user at /users/4t3ExI1SrUd7NeqJaMX4p0MtniB2.
     * @deny (delete) User 'randomId' cannot delete the profile for a different user at /users/4t3ExI1SrUd7NeqJaMX4p0MtniB2.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree, validates relational integrity between documents.
     */
    match /users/{userId} {
      allow read, write, create, update, delete: if request.auth.uid == userId;
      allow list: if false;
    }

    /**
     * @description Secure user's mandala progress data. Only the user can read/write their own progress.
     * @path /users/{userId}/mandalaProgress/{mandalaId}
     * @allow (create) User '4t3ExI1SrUd7NeqJaMX4p0MtniB2' can create their own mandala progress at /users/4t3ExI1SrUd7NeqJaMX4p0MtniB2/mandalaProgress/agni.
     * @allow (get) User '4t3ExI1SrUd7NeqJaMX4p0MtniB2' can read their own mandala progress at /users/4t3ExI1SrUd7NeqJaMX4p0MtniB2/mandalaProgress/agni.
     * @allow (list) User '4t3ExI1SrUd7NeqJaMX4p0MtniB2' can list their own mandala progress at /users/4t3ExI1SrUd7NeqJaMX4p0MtniB2/mandalaProgress.
     * @allow (update) User '4t3ExI1SrUd7NeqJaMX4p0MtniB2' can update their own mandala progress at /users/4t3ExI1SrUd7NeqJaMX4p0MtniB2/mandalaProgress/agni.
     * @allow (delete) User '4t3ExI1SrUd7NeqJaMX4p0MtniB2' can delete their own mandala progress at /users/4t3ExI1SrUd7NeqJaMX4p0MtniB2/mandalaProgress/agni.
     * @deny (create) User 'randomId' cannot create mandala progress for another user at /users/4t3ExI1SrUd7NeqJaMX4p0MtniB2/mandalaProgress/agni.
     * @deny (get) User 'randomId' cannot read mandala progress for another user at /users/4t3ExI1SrUd7NeqJaMX4p0MtniB2/mandalaProgress/agni.
     * @deny (update) User 'randomId' cannot update mandala progress for another user at /users/4t3ExI1SrUd7NeqJaMX4p0MtniB2/mandalaProgress/agni.
     * @deny (delete) User 'randomId' cannot delete mandala progress for another user at /users/4t3ExI1SrUd7NeqJaMX4p0MtniB2/mandalaProgress/agni.
     * @principle Enforces document ownership for writes and restricts access to a user's own data.
     */
    match /users/{userId}/mandalaProgress/{mandalaId} {
      allow read, write, create, update, delete: if request.auth.uid == userId;
      allow list: if request.auth.uid == userId;
    }

    /**
     * @description Allow public read access to mandala puzzles.  Writes are disallowed.
     * @path /mandalaPuzzles/{mandalaId}
     * @allow (get) Any user can read a mandala puzzle at /mandalaPuzzles/agni.
     * @allow (list) Any user can list mandala puzzles at /mandalaPuzzles.
     * @deny (create) No user can create a mandala puzzle at /mandalaPuzzles/agni.
     * @deny (update) No user can update a mandala puzzle at /mandalaPuzzles/agni.
     * @deny (delete) No user can delete a mandala puzzle at /mandalaPuzzles/agni.
     * @principle Grants public read access while restricting writes.
     */
    match /mandalaPuzzles/{mandalaId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allow public read access to cultural insights.  Writes are disallowed.
     * @path /culturalInsights/{culturalInsightId}
     * @allow (get) Any user can read a cultural insight at /culturalInsights/insight1.
     * @allow (list) Any user can list cultural insights at /culturalInsights.
     * @deny (create) No user can create a cultural insight at /culturalInsights/insight1.
     * @deny (update) No user can update a cultural insight at /culturalInsights/insight1.
     * @deny (delete) No user can delete a cultural insight at /culturalInsights/insight1.
     * @principle Grants public read access while restricting writes.
     */
    match /culturalInsights/{culturalInsightId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }
  }
}